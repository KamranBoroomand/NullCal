name: Deploy to GitHub Pages

on:
  push:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install --no-audit --no-fund

      - name: Quality checks
        run: |
          npm run lint
          npm run typecheck
          npm run test:unit

      - name: Resolve base path
        id: resolve-base
        run: |
          if [ -f public/CNAME ]; then
            echo "vite_base=/" >> "$GITHUB_OUTPUT"
          else
            echo "vite_base=/${{ github.event.repository.name }}/" >> "$GITHUB_OUTPUT"
          fi

      - name: Echo base path
        run: echo "VITE_BASE=${{ steps.resolve-base.outputs.vite_base }}"

      - name: Validate notification gateway config
        env:
          NOTIFY_API_VAR: "${{ vars.VITE_NOTIFICATION_API }}"
          NOTIFY_API_SECRET: "${{ secrets.VITE_NOTIFICATION_API }}"
          NOTIFY_TOKEN_VAR: "${{ vars.VITE_NOTIFICATION_TOKEN }}"
          NOTIFY_TOKEN_SECRET: "${{ secrets.VITE_NOTIFICATION_TOKEN }}"
        run: |
          NOTIFY_API="${NOTIFY_API_VAR:-$NOTIFY_API_SECRET}"
          NOTIFY_TOKEN="${NOTIFY_TOKEN_VAR:-$NOTIFY_TOKEN_SECRET}"
          if [ -f public/CNAME ] && [ -z "$NOTIFY_API" ]; then
            echo "::error::VITE_NOTIFICATION_API is required for OTP email/SMS on static hosting. Configure it to your worker /api URL before deploy."
            exit 1
          fi
          if [ -n "$NOTIFY_API" ] && [ -z "$NOTIFY_TOKEN" ]; then
            echo "::warning::VITE_NOTIFICATION_TOKEN is empty. If NOTIFY_REQUEST_TOKEN is enforced on the backend, OTP delivery will fail with 401."
          fi

      - name: Build
        run: npm run build
        env:
          VITE_BASE: "${{ steps.resolve-base.outputs.vite_base }}"
          VITE_NOTIFICATION_API: "${{ vars.VITE_NOTIFICATION_API != '' && vars.VITE_NOTIFICATION_API || secrets.VITE_NOTIFICATION_API }}"
          VITE_NOTIFICATION_TOKEN: "${{ vars.VITE_NOTIFICATION_TOKEN != '' && vars.VITE_NOTIFICATION_TOKEN || secrets.VITE_NOTIFICATION_TOKEN }}"

      - name: Sanity check build base
        run: |
          ls -la dist/assets
          if [ "${{ steps.resolve-base.outputs.vite_base }}" = "/" ]; then
            grep -q '"/assets/' dist/index.html
          else
            grep -q "/${{ github.event.repository.name }}/assets/" dist/index.html
          fi

      - name: Configure Pages
        id: pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

      - name: Deploy
        uses: actions/deploy-pages@v4
